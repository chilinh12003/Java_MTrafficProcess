package MyProcessMO;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;

import MyCharge.Charge;
import MyCharge.Charge.ErrorCode;
import MyDataSource.MyDataRow;
import MyDataSource.MyTableModel;

import MyProcessServer.Common;
import MyProcessServer.ContentAbstract;
import MyProcessServer.Keyword;
import MyProcessServer.LocalConfig;
import MyProcessServer.MsgObject;

import MyUtility.MyConfig;
import MyUtility.MyConfig.ChannelType;
import MyUtility.MyConvert;
import MyUtility.MyLogger;
import Service.DefineMT;
import Service.MOLog;
import Service.DefineMT.MTType;
import Service.ServiceObject;
import Sub.Subscriber;
import Sub.SubscriberObject;
import Sub.UnSubscriber;

public class Register extends ContentAbstract
{
	MyLogger mLog = new MyLogger(this.getClass().toString());
	Collection<MsgObject> ListMessOject = new ArrayList<MsgObject>();

	MsgObject mMsgObject = null;
	SubscriberObject mSubObj = new SubscriberObject();

	ServiceObject mServiceObj = new ServiceObject();
	Calendar mCal_Current = Calendar.getInstance();
	Calendar mCal_SendMO = Calendar.getInstance();
	Calendar mCal_Expire = Calendar.getInstance();

	Subscriber mSub = null;
	UnSubscriber mUnSub = null;
	MOLog mMOLog = null;
	Service.Keyword mKeyword = null;

	MyTableModel mTable_MOLog = null;
	MyTableModel mTable_Sub = null;

	DefineMT.MTType mMTType = MTType.RegFail;

	private int FreeCount = 7;
	String MTContent = "";
	
	String FreeTime = "7 ngay";
	
	private void Init(MsgObject msgObject, Keyword keyword) throws Exception
	{
		try
		{
			mSub = new Subscriber(LocalConfig.PoolName_Data_SQL);
			mUnSub = new UnSubscriber(LocalConfig.PoolName_Data_SQL);
			mMOLog = new MOLog(LocalConfig.PoolName_Data_SQL);
			mKeyword = new Service.Keyword(LocalConfig.PoolName_Data_SQL);

			mTable_MOLog = mMOLog.Select(0);
			mTable_Sub = mSub.Select(0);

			mMsgObject = msgObject;

			mCal_SendMO.setTime(mMsgObject.getTTimes());

			mCal_Expire.set(Calendar.MILLISECOND, 0);
			mCal_Expire.set(mCal_Current.get(Calendar.YEAR), mCal_Current.get(Calendar.MONTH),
					mCal_Current.get(Calendar.DATE), 23, 59, 59);
		}
		catch (Exception ex)
		{
			throw ex;
		}
	}

	private Collection<MsgObject> AddToList() throws Exception
	{
		try
		{
			ListMessOject.clear();
			MTContent = Common.GetDefineMT_Message(mMTType, mServiceObj);

			MTContent = MTContent.replace("[FreeTime]", FreeTime);
			MTContent = MTContent.replace("[ExpireDate]",
					MyConfig.Get_DateFormat_VNShortSlash().format(mCal_Expire.getTime()));

			mMsgObject.setUsertext(MTContent);

			mMsgObject.setContenttype(21);
			mMsgObject.setMsgtype(1);

			ListMessOject.add(new MsgObject(mMsgObject));
			return ListMessOject;
		}
		catch (Exception ex)
		{
			throw ex;
		}
	}

	private void Insert_MOLog() throws Exception
	{
		try
		{
			mTable_MOLog.Clear();
			MyDataRow mRow_Log = mTable_MOLog.CreateNewRow();

			mRow_Log.SetValueCell("ServiceID", mServiceObj.ServiceID);
			mRow_Log.SetValueCell("MSISDN", mMsgObject.getUserid());
			mRow_Log.SetValueCell("ReceiveDate", MyConfig.Get_DateFormat_InsertDB().format(mCal_SendMO.getTime()));
			mRow_Log.SetValueCell("LogDate", MyConfig.Get_DateFormat_InsertDB().format(mCal_Current.getTime()));
			mRow_Log.SetValueCell("ChannelTypeID", mMsgObject.getChannelType());
			mRow_Log.SetValueCell("ChannelTypeName", MyConfig.ChannelType.FromInt(mMsgObject.getChannelType())
					.toString());
			mRow_Log.SetValueCell("MTTypeID", mMTType.GetValue());
			mRow_Log.SetValueCell("MTTypeName", mMTType.toString());
			mRow_Log.SetValueCell("MO", mMsgObject.getMO());
			mRow_Log.SetValueCell("MT", MTContent);
			mRow_Log.SetValueCell("LogContent", "DKDV:" + mServiceObj.ServiceName);
			mRow_Log.SetValueCell("PID", MyConvert.GetPIDByMSISDN(mMsgObject.getUserid(), LocalConfig.MAX_PID));
			mRow_Log.SetValueCell("RequestID", mMsgObject.getRequestid().toString());

			mRow_Log.SetValueCell("PartnerID", mSubObj.PartnerID);

			mTable_MOLog.AddNewRow(mRow_Log);

			mMOLog.Insert(0, mTable_MOLog.GetXML());
		}
		catch (Exception ex)
		{
			mLog.log.error(ex);
		}
	}

	private MyTableModel AddInfo() throws Exception
	{
		try
		{
			MyTableModel mTable_Sub = mSub.Select(0);
			mTable_Sub.Clear();

			// Tạo row để insert vào Table Sub
			MyDataRow mRow_Sub = mTable_Sub.CreateNewRow();
			mRow_Sub.SetValueCell("MSISDN", mSubObj.MSISDN);
			mRow_Sub.SetValueCell("ServiceID", mSubObj.ServiceID);

			mRow_Sub.SetValueCell("FirstDate", MyConfig.Get_DateFormat_InsertDB().format(mSubObj.FirstDate));
			mRow_Sub.SetValueCell("EffectiveDate", MyConfig.Get_DateFormat_InsertDB().format(mSubObj.EffectiveDate));
			mRow_Sub.SetValueCell("ExpiryDate", MyConfig.Get_DateFormat_InsertDB().format(mSubObj.ExpiryDate));

			mRow_Sub.SetValueCell("RetryChargeCount", mSubObj.RetryChargeCount);

			if (mSubObj.ChargeDate != null)
				mRow_Sub.SetValueCell("ChargeDate", MyConfig.Get_DateFormat_InsertDB().format(mSubObj.ChargeDate));

			mRow_Sub.SetValueCell("ChannelTypeID", mSubObj.ChannelTypeID);
			mRow_Sub.SetValueCell("ChannelTypeName", mSubObj.ChannelTypeName);
			mRow_Sub.SetValueCell("StatusID", mSubObj.StatusID);
			mRow_Sub.SetValueCell("StatusName", mSubObj.StatusName);
			mRow_Sub.SetValueCell("PID", mSubObj.PID);
			mRow_Sub.SetValueCell("TotalMT", mSubObj.TotalMT);
			mRow_Sub.SetValueCell("TotalMTByDay", mSubObj.TotalMTByDay);

			mRow_Sub.SetValueCell("PartnerID", mSubObj.PartnerID);

			if (mSubObj.LastUpdate != null)
				mRow_Sub.SetValueCell("LastUpdate", MyConfig.Get_DateFormat_InsertDB().format(mSubObj.LastUpdate));

			// Lấy lại thời gian Hủy
			if (mSubObj.DeregDate != null)
				mRow_Sub.SetValueCell("DeregDate", MyConfig.Get_DateFormat_InsertDB().format(mSubObj.DeregDate));

			mTable_Sub.AddNewRow(mRow_Sub);
			return mTable_Sub;
		}
		catch (Exception ex)
		{
			throw ex;
		}
	}

	private boolean Insert_Sub() throws Exception
	{
		try
		{
			MyTableModel mTable_Sub = AddInfo();

			if (!mSub.Insert(0, mTable_Sub.GetXML()))
			{
				mLog.log.info("Insert vao table Subscriber KHONG THANH CONG: XML Insert-->" + mTable_Sub.GetXML());
				return false;
			}

			return true;
		}
		catch (Exception ex)
		{
			throw ex;
		}
	}

	private boolean MoveToUnSub() throws Exception
	{
		try
		{
			MyTableModel mTable_Sub = AddInfo();

			if (!mSub.Move(0, mTable_Sub.GetXML()))
			{
				mLog.log.info("Move tu UnSub Sang Sub KHONG THANH CONG: XML Insert-->" + mTable_Sub.GetXML());
				return false;
			}

			return true;
		}
		catch (Exception ex)
		{
			throw ex;
		}
	}

	/**
	 * tạo dữ liệu cho những đăng ký lại (trước đó đã hủy dịch vụ)
	 * 
	 * @throws Exception
	 */
	private void CreateRegAgain() throws Exception
	{
		try
		{
			mSubObj.ChannelTypeID = mMsgObject.getChannelType();
			mSubObj.ChannelTypeName = MyConfig.ChannelType.FromInt(mMsgObject.getChannelType()).toString();

			mSubObj.EffectiveDate = mCal_Current.getTime();
			mSubObj.ExpiryDate = mCal_Expire.getTime();

			mSubObj.LastUpdate = mCal_Current.getTime();
			mSubObj.MSISDN = mMsgObject.getUserid();
			mSubObj.PID = MyConvert.GetPIDByMSISDN(mSubObj.MSISDN, LocalConfig.MAX_PID);
			mSubObj.ServiceID = mServiceObj.ServiceID;
			mSubObj.StatusID = Subscriber.Status.Active.GetValue();
			mSubObj.StatusName = Subscriber.Status.Active.toString();
			mSubObj.TotalMTByDay = 0;
		}
		catch (Exception ex)
		{
			throw ex;
		}

	}

	/**
	 * Tạo dữ liệu cho một đăng ký mới
	 * 
	 * @throws Exception
	 */
	private void CreateNewReg() throws Exception
	{
		try
		{
			mSubObj.ChannelTypeID = mMsgObject.getChannelType();
			mSubObj.ChannelTypeName = MyConfig.ChannelType.FromInt(mMsgObject.getChannelType()).toString();
			mSubObj.ChargeDate = null;
			mSubObj.DeregDate = null;
			mSubObj.EffectiveDate = mCal_Current.getTime();
			mSubObj.ExpiryDate = mCal_Expire.getTime();
			mSubObj.FirstDate = mCal_Current.getTime();
			mSubObj.IsDereg = false;
			mSubObj.LastUpdate = mCal_Current.getTime();
			mSubObj.MSISDN = mMsgObject.getUserid();
			mSubObj.PID = MyConvert.GetPIDByMSISDN(mSubObj.MSISDN, LocalConfig.MAX_PID);
			mSubObj.ServiceID = mServiceObj.ServiceID;
			mSubObj.StatusID = Subscriber.Status.Active.GetValue();
			mSubObj.StatusName = Subscriber.Status.Active.toString();
			mSubObj.TotalMT = 0;
			mSubObj.TotalMTByDay = 0;

		}
		catch (Exception ex)
		{
			throw ex;
		}
	}

	protected Collection<MsgObject> getMessages(MsgObject msgObject, Keyword keyword) throws Exception
	{
		try
		{
			// Khoi tao
			Init(msgObject, keyword);

			if (MyUtility.MyConfig.ChannelType.FromInt(mMsgObject.getChannelType()) == ChannelType.WAP)
			{
				// nếu đăng ký từ wap thì sẽ dựa vào table Keyword (MS SQL) để
				// lấy dịch vụ
				MyTableModel mTable_Keyword = mKeyword.Select(4, mMsgObject.getKeyword());
				if (mTable_Keyword.GetRowCount() > 0 && mTable_Keyword.GetValueAt(0, "ServiceID") != null)
				{
					Integer mServiceID = Integer.parseInt(mTable_Keyword.GetValueAt(0, "ServiceID").toString());
					mServiceObj = Common.GetService(mServiceID);
				}
				else
				{
					mServiceObj = Common.GetService(mMsgObject.getUsertext(), "");
				}
			}
			else
			{
				// Lấy service
				mServiceObj = Common.GetService(mMsgObject.getUsertext(), "");
			}

			if (mServiceObj.IsNull())
			{
				mLog.log.info("Dich vu khong ton tai.");
				mMTType = MTType.Invalid;
				return AddToList();
			}

			Integer PID = MyConvert.GetPIDByMSISDN(mMsgObject.getUserid(), LocalConfig.MAX_PID);
			// Lấy thông tin khách hàng đã đăng ký
			MyTableModel mTable_Sub = mSub.Select(2, PID.toString(), mMsgObject.getUserid(),
					mServiceObj.ServiceID.toString());

			mSubObj = SubscriberObject.Convert(mTable_Sub, false);

			if (mSubObj.IsNull())
			{
				mTable_Sub = mUnSub.Select(2, PID.toString(), mMsgObject.getUserid(), mServiceObj.ServiceID.toString());

				if (mTable_Sub.GetRowCount() > 0) mSubObj = SubscriberObject.Convert(mTable_Sub, true);
			}

			mSubObj.PID = MyConvert.GetPIDByMSISDN(mMsgObject.getUserid(), LocalConfig.MAX_PID);

			mSubObj.PartnerID = mKeyword.GetPartnerID(msgObject.getKeyword());

			// Đăng ký mới (chưa từng đăng ký trước đây)
			if (mSubObj.IsNull())
			{
				// Miễn phí 6 ngày tính cả ngày hôm nay
				mCal_Expire.add(Calendar.DATE, 7);

				// Tạo dữ liệu cho đăng ký mới
				CreateNewReg();

				ErrorCode mResult = Charge.ChargeRegFree(mSubObj.PartnerID, mServiceObj, mMsgObject.getUserid(),
						mMsgObject.getKeyword(), MyUtility.MyConfig.ChannelType.FromInt(mMsgObject.getChannelType()));
				if (mResult != ErrorCode.ChargeSuccess)
				{
					mMTType = MTType.RegFail; // Đăng ký lại nhưng miễn phí
					return AddToList();
				}

				if (Insert_Sub())
				{
					mMTType = MTType.RegNewSuccess;
				}
				else
				{
					mMTType = MTType.RegFail;
				}

				return AddToList();
			}

			// Nếu đã đăng ký rồi và tiếp tục đăng ký
			if (!mSubObj.IsNull() && mSubObj.IsDereg == false)
			{
				// Kiểm tra còn free hay không
				if (mSubObj.FirstDate.getTime() == mSubObj.EffectiveDate.getTime() && mSubObj.IsFreeReg(FreeCount))
				{
					mMTType = MTType.RegRepeatFree;
					return AddToList();
				}
				else
				{
					mMTType = MTType.RegRepeatNotFree;
					return AddToList();
				}
			}

			// Nếu trước đó số điện thoại đã được Hủy thuê bao
			if (mSubObj.IsDereg && mSubObj.StatusID == Subscriber.Status.UndoSub.GetValue())
			{
				// Miễn phí 6 ngày tính cả ngày hôm nay
				mCal_Expire.add(Calendar.DATE, 7);

				CreateRegAgain();
				ErrorCode mResult = Charge.ChargeRegFree(mSubObj.PartnerID, mServiceObj,mMsgObject.getUserid(), mMsgObject.getKeyword(),
						MyUtility.MyConfig.ChannelType.FromInt(mMsgObject.getChannelType()));
				if (mResult != ErrorCode.ChargeSuccess)
				{
					mMTType = MTType.RegFail;
					return AddToList();
				}

				if (MoveToUnSub())
				{
					mMTType = MTType.RegNewSuccess;
				}
				else
				{
					mMTType = MTType.RegFail;
				}

				return AddToList();
			}

			// Đã đăng ký trước đó nhưng đang hủy
			if (mSubObj.IsDereg)
			{
				// Nếu là đăng ký và hết thời gian khuyến mại thì tiến hành
				// charge trước
				/*
				 * if (mSubObj.IsFreeReg(FreeCount)) { //Nếu còn miễn phí
				 * thì cho free đến hết ngày miễn phí đó
				 * mCal_Expire.setTime(mSubObj.ExpiryDate);
				 * 
				 * CreateRegAgain();
				 * 
				 * ErrorCode mResult =
				 * Charge.ChargeRegFree(mSubObj.PartnerID,mServiceObj,
				 * mMsgObject.getUserid(), mMsgObject.getKeyword(),
				 * MyUtility.MyConfig
				 * .ChannelType.FromInt(mMsgObject.getChannelType())); if
				 * (mResult != ErrorCode.ChargeSuccess) { mMTType =
				 * MTType.RegFail; // Đăng ký lại nhưng miễn phí return
				 * AddToList(); } // Nếu xóa unsub hoặc Insert sub không thành
				 * công thì thông // báo lỗi if (MoveToUnSub()) { mMTType =
				 * MTType.RegAgainSuccessFree; return AddToList(); }
				 * 
				 * mMTType = MTType.RegFail; // Đăng ký lại nhưng miễn phí
				 * return AddToList(); } else
				 */
				if (!mSubObj.IsFreeReg(90)) // sau 90 ngày số điện thoại
											// được đăng
				{
					// Miễn phí 6 ngày tính cả ngày hôm nay
					mCal_Expire.add(Calendar.DATE, 6);

					CreateRegAgain();

					ErrorCode mResult = Charge.ChargeRegFree(mSubObj.PartnerID, mServiceObj, mMsgObject.getUserid(),
							mMsgObject.getKeyword(),
							MyUtility.MyConfig.ChannelType.FromInt(mMsgObject.getChannelType()));
					if (mResult != ErrorCode.ChargeSuccess)
					{
						mMTType = MTType.RegFail; // Đăng ký lại nhưng miễn phí
						return AddToList();
					}
					// Nếu xóa unsub hoặc Insert sub không thành công thì thông
					// báo lỗi
					if (MoveToUnSub())
					{
						mMTType = MTType.RegAgainSuccessFree;
						return AddToList();
					}

					mMTType = MTType.RegFail; // Đăng ký lại nhưng miễn phí
					return AddToList();
				}
				else
				{
					CreateRegAgain();

					// đồng bộ thuê bao sang Vinpahone
					ErrorCode mResult = Charge.ChargeReg(mSubObj.PartnerID, mServiceObj, mMsgObject.getUserid(),
							mMsgObject.getKeyword(),
							MyUtility.MyConfig.ChannelType.FromInt(mMsgObject.getChannelType()));

					// Charge
					if (mResult == ErrorCode.BlanceTooLow)
					{
						mMTType = MTType.RegNotEnoughMoney;
						return AddToList();
					}
					if (mResult != ErrorCode.ChargeSuccess)
					{
						mMTType = MTType.RegFail; // Đăng ký lại nhưng mất tiền
						return AddToList();
					}

					// Nếu xóa unsub hoặc Insert sub không thành công thì thông
					// báo lỗi
					if (MoveToUnSub())
					{
						mMTType = MTType.RegAgainSuccessNotFree;
						return AddToList();
					}

					mMTType = MTType.RegFail; // Đăng ký lại nhưng mất tiền
					return AddToList();
				}
			}

			mMTType = MTType.RegFail;
			return AddToList();
		}
		catch (Exception ex)
		{
			mLog.log.error(Common.GetStringLog(msgObject), ex);
			mMTType = MTType.RegFail;
			return AddToList();
		}
		finally
		{
			// Insert vao log
			Insert_MOLog();
			mLog.log.debug(Common.GetStringLog(mMsgObject));
		}
	}

}
